# I2C Bus Config (Used by RTC and Environmental Sensor)
i2c:
  scl: GPIO5
  sda: GPIO6
  scan: true
  
# UART used for Radar Sensor (LD2410) communication
uart:
  id: uart_bus
  baud_rate: 256000
  tx_pin: GPIO0
  rx_pin: GPIO1
  parity: NONE
  stop_bits: 1

ld2410:

sensor:
  # AHT20 Temperature & Humidity Sensor
  - platform: aht10
    variant: AHT20
    address: 0x38
    temperature:
      id: temp_sensor
      name: "Temperature"
      icon: mdi:thermometer
      web_server:
        sorting_group_id: sorting_sensors
        sorting_weight: 1
    humidity:
      id: humidity_sensor
      name: "Humidity"
      icon: mdi:water-percent
      web_server:
        sorting_group_id: sorting_sensors
        sorting_weight: 2
        
  # Light Sensor (ADC)
  - platform: adc
    pin: GPIO4
    name: "Brightness"
    id: brightness_sensor
    icon: mdi:brightness-6
    accuracy_decimals: 0
    web_server:
      sorting_group_id: sorting_sensors
      sorting_weight: 3
    attenuation: 12db
    update_interval: 5s
    unit_of_measurement: "%"
    filters:
      # Map raw voltage (0-3V) into a percentage
      - calibrate_linear:
          - 0.0 -> 0.0
          - 3.0 -> 100.0
      # Compensate for light interference from the clock's own LEDs
      - lambda: |-
          float interference = id(RingClock)->get_interference_factor();
          
          // Apply inverse weighting based on current LED brightness
          // '1.8' is the damping factor - higher means more suppression
          float factor = 1.0f / (1.0f + (interference * 1.8f));
          
          float adjusted_value = x * factor;
          
          // Clamp result between 0-100%
          return adjusted_value < 0 ? 0 : (adjusted_value > 100 ? 100 : adjusted_value);
      # Smooth out jitter
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

binary_sensor:
  # MMwave Radar Presence Detection (LD2410)
  - platform: ld2410
    has_target:
      name: Occupancy
      web_server:
        sorting_group_id: sorting_sensors
      # Trigger brightness changes based on presence
      on_press:
        - if:
            condition:
              - switch.is_on: presense_detection
            then:
              - light.turn_on:
                  id: ring_light
                  brightness:  !lambda 'return id(standard_percentage)->state/100;'
                  transition_length: 1s
      on_release:
        - if:
            condition:
              - switch.is_on: presense_detection
            then:
              - light.turn_on:
                  id: ring_light
                  brightness:  !lambda 'return id(low_percentage)->state/100;'
                  transition_length: 1s
    has_moving_target:
      name: Moving Target
      web_server:
        sorting_group_id: sorting_sensors
        sorting_weight: 4
    has_still_target:
      name: Still Target
      web_server:
        sorting_group_id: sorting_sensors
        sorting_weight: 5
        
  # LD2410 Presence input
  - platform: gpio
    pin: GPIO3
    name: "Presence"
    web_server:
      sorting_group_id: sorting_sensors
    device_class: presence

# System Output Hardware
output:
  # Buzzer connected to GPIO7
  - platform: ledc
    pin: GPIO7
    id: buzzer

# RTTTL (Ring Tone Text Transfer Language)
# Used for playing melodies (alarms, notifications)
rtttl:
  output: buzzer
  id: buzzer_rtttl
  gain: 90%
